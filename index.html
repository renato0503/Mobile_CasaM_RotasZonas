<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CASA MASSIMA | Routes</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* =========================================
           iOS / APPLE THEME VARIABLES
           ========================================= */
        :root {
            --ios-bg: #000000;
            --ios-card: #1c1c1e;
            --ios-card-border: #2c2c2e;
            --ios-input-bg: #2c2c2e;
            --ios-header-bg: rgba(28, 28, 30, 0.85);
            
            --brand-red: #ff453a;
            --brand-gold: #ffd60a;
            --brand-blue: #0a84ff;
            --brand-green: #30d158;
            --brand-orange: #ff9f0a;
            
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --text-tertiary: #48484a;

            --radius-l: 20px;
            --radius-m: 12px;
            --radius-s: 8px;
            
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: var(--ios-bg);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 15px;
            overflow: hidden; /* Map takes full screen */
            height: 100vh;
            width: 100vw;
        }

        /* =========================================
           HEADER & NAVIGATION
           ========================================= */
        .app-header {
            position: fixed; top: 0; left: 0; right: 0;
            height: calc(60px + var(--safe-area-top));
            padding-top: var(--safe-area-top);
            background: var(--ios-header-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid var(--ios-card-border);
            display: flex; align-items: center; justify-content: space-between;
            padding-left: 16px; padding-right: 16px;
            z-index: 1000;
        }

        .header-left { display: flex; align-items: center; gap: 15px; }
        .menu-btn { background: none; border: none; color: var(--brand-gold); font-size: 22px; cursor: pointer; padding: 5px; }
        .app-title { font-weight: 700; font-size: 17px; letter-spacing: -0.5px; }
        .app-title span { display: block; font-size: 10px; color: var(--text-secondary); font-weight: 400; text-transform: uppercase; }
        .header-actions { display: flex; gap: 15px; }
        .action-btn { background: none; border: none; color: var(--brand-blue); font-size: 18px; cursor: pointer; }

        /* =========================================
           SIDEBAR (DRAWER)
           ========================================= */
        .drawer-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 1100;
            opacity: 0; pointer-events: none; transition: 0.3s ease;
            backdrop-filter: blur(2px);
        }
        .drawer-overlay.active { opacity: 1; pointer-events: all; }

        .drawer {
            position: fixed; top: 0; left: 0; bottom: 0;
            width: 280px; background: var(--ios-card);
            transform: translateX(-100%); transition: 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            z-index: 1101; padding: 30px 20px;
            display: flex; flex-direction: column;
            border-right: 1px solid var(--ios-card-border);
        }
        .drawer.active { transform: translateX(0); }

        .brand-profile { margin-bottom: 30px; display: flex; align-items: center; gap: 15px; }
        .brand-logo { 
            width: 48px; height: 48px; border-radius: 12px; 
            background: linear-gradient(135deg, #7a1f20, #3e1213);
            display: flex; align-items: center; justify-content: center;
            color: var(--brand-gold); font-weight: 800; font-size: 20px;
            box-shadow: 0 4px 15px rgba(122, 31, 32, 0.4);
        }
        
        .nav-list { list-style: none; padding: 0; margin: 0; flex: 1; }
        .nav-item { margin-bottom: 10px; }
        .nav-link {
            display: flex; align-items: center; gap: 15px;
            padding: 14px; border-radius: 12px;
            color: var(--text-secondary); text-decoration: none;
            font-weight: 600; font-size: 15px; transition: 0.2s;
        }
        .nav-link.active { background: rgba(255, 69, 58, 0.15); color: var(--brand-red); }
        .user-info { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--ios-card-border); display: flex; align-items: center; gap: 12px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }

        /* =========================================
           MAP & LAYOUT
           ========================================= */
        #map {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1; background: #121212;
        }

        /* Floating Info Badge on Map */
        .map-badge {
            position: absolute; top: calc(70px + var(--safe-area-top)); left: 16px; right: 16px;
            background: rgba(28, 28, 30, 0.9); backdrop-filter: blur(10px);
            padding: 10px 15px; border-radius: 12px; border: 1px solid var(--ios-card-border);
            z-index: 500; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .mb-item { text-align: center; }
        .mb-label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; display: block; }
        .mb-val { font-size: 13px; font-weight: 700; color: white; display: block; }

        /* Bottom Sheet (Routes List) */
        .bottom-sheet {
            position: absolute; bottom: 0; left: 0; right: 0;
            height: 45vh; /* Initial height */
            background: var(--ios-card);
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            z-index: 800; box-shadow: 0 -5px 30px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
            transition: height 0.3s ease;
        }
        
        .sheet-handle-area {
            width: 100%; height: 30px; display: flex; justify-content: center; align-items: center;
            flex-shrink: 0; cursor: grab;
        }
        .sheet-handle { width: 40px; height: 5px; background: #444; border-radius: 3px; }

        .sheet-content {
            flex: 1; overflow-y: auto; padding: 0 16px 20px 16px;
            -webkit-overflow-scrolling: touch;
        }

        .sheet-title { font-size: 14px; font-weight: 700; color: white; margin-bottom: 15px; display: flex; justify-content: space-between; }

        /* Route Card */
        .route-card {
            background: var(--ios-input-bg); border-radius: 12px; padding: 15px; margin-bottom: 12px;
            position: relative; border-left: 4px solid transparent;
        }
        .route-card.high { border-left-color: var(--brand-green); }
        .route-card.med { border-left-color: var(--brand-orange); }
        .route-card.low { border-left-color: var(--brand-red); }

        .rc-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .rc-name { font-weight: 700; font-size: 14px; color: white; }
        .rc-dist { font-size: 11px; color: var(--text-secondary); background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; }

        .rc-stats { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); }
        .rc-stats strong { color: white; }

        /* FAB */
        .fab {
            position: absolute; bottom: calc(45vh + 20px); right: 16px;
            width: 50px; height: 50px; background: var(--brand-blue);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            color: white; font-size: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            z-index: 900; transition: bottom 0.3s ease; border: none;
        }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 2000; display: none; align-items: flex-end; justify-content: center;
        }
        .modal-sheet {
            background: var(--ios-card); width: 100%; max-width: 600px;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 25px; padding-bottom: calc(25px + var(--safe-area-bottom));
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Inputs */
        .ios-input-group { margin-bottom: 15px; }
        .ios-label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 5px; text-transform: uppercase; }
        .ios-input { width: 100%; background: var(--ios-input-bg); border: none; border-radius: 8px; padding: 12px; color: white; font-size: 16px; }
        .ios-btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; background: var(--brand-gold); color: black; }

        /* Leaflet Overrides */
        .leaflet-control-zoom { display: none; } /* Hide default zoom controls on mobile */
        .leaflet-popup-content-wrapper { background: #252525; color: white; border-radius: 8px; font-family: -apple-system; }
        .leaflet-popup-tip { background: #252525; }

    </style>
</head>
<body>

    <div class="drawer-overlay" id="drawerOverlay" onclick="toggleMenu()"></div>
    <aside class="drawer" id="mainDrawer">
        <div class="brand-profile">
            <div class="brand-logo">M</div>
            <div>
                <div style="font-weight:700; font-size:16px;">CASA MASSIMA</div>
                <div style="font-size:11px; color:var(--text-secondary);">Enterprise ERP</div>
            </div>
        </div>
        
        <ul class="nav-list">
            <li class="nav-item">
                <a href="https://renato0503.github.io/Mobile_CasaM_Menu/" class="nav-link">
                    <i class="fa fa-truck-fast"></i> Simulador Logístico
                </a>
            </li>
            <li class="nav-item">
                <a href="https://renato0503.github.io/Mobile_CasaM_PerformanceComercial/" class="nav-link">
                    <i class="fa fa-chart-line"></i> Performance
                </a>
            </li>
            <li class="nav-item">
                <a href="https://renato0503.github.io/Mobile_CasaM_EquipeVendas/" class="nav-link">
                    <i class="fa fa-users"></i> Equipe
                </a>
            </li>
            <li class="nav-item">
                <a href="https://renato0503.github.io/Mobile_CasaM_Comissoes/" class="nav-link">
                    <i class="fa fa-file-invoice-dollar"></i> Comissões
                </a>
            </li>
            <li class="nav-item">
                <a href="https://renato0503.github.io/Mobile_CasaM_RotasZonas/" class="nav-link active">
                    <i class="fa fa-map-location-dot"></i> Rotas & Zonas
                </a>
            </li>
        </ul>

        <div class="user-info">
            <div class="avatar">F</div>
            <div>
                <div style="font-weight:600; font-size:14px;">Fausto</div>
                <div style="font-size:11px; color:var(--text-secondary);">Administrador</div>
            </div>
        </div>
    </aside>

    <header class="app-header">
        <div class="header-left">
            <button class="menu-btn" onclick="toggleMenu()"><i class="fa fa-bars"></i></button>
            <div class="app-title">Rotas MT <span>Monitoramento</span></div>
        </div>
        <div class="header-actions">
            </div>
    </header>

    <div id="map"></div>

    <div class="map-badge">
        <div class="mb-item">
            <span class="mb-label">Diesel Med.</span>
            <span class="mb-val" style="color:var(--brand-gold)">R$ 6,52</span>
        </div>
        <div class="mb-item" style="border-left:1px solid #444; padding-left:15px; margin-left:15px">
            <span class="mb-label">Rotas Ativas</span>
            <span class="mb-val">5</span>
        </div>
        <div class="mb-item" style="border-left:1px solid #444; padding-left:15px; margin-left:15px">
            <span class="mb-label">Eficiência</span>
            <span class="mb-val" style="color:var(--brand-green)">92%</span>
        </div>
    </div>

    <button class="fab" onclick="openCalc()">
        <i class="fa fa-calculator"></i>
    </button>

    <div class="bottom-sheet">
        <div class="sheet-handle-area">
            <div class="sheet-handle"></div>
        </div>
        <div class="sheet-content">
            <div class="sheet-title">
                <span>Zonas de Atuação</span>
                <i class="fa fa-layer-group" style="color:var(--text-secondary)"></i>
            </div>
            
            <div style="height:120px; width:100%; margin-bottom:20px; background:rgba(255,255,255,0.03); border-radius:12px; padding:10px">
                <canvas id="zoneChart"></canvas>
            </div>

            <div id="routesContainer">
                </div>
        </div>
    </div>

    <div class="modal-overlay" id="calcModal" onclick="closeCalc(event)">
        <div class="modal-sheet">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px">
                <span style="font-weight:700; font-size:18px">Calculadora Retorno</span>
                <i class="fa fa-times" onclick="document.getElementById('calcModal').style.display='none'" style="padding:5px"></i>
            </div>
            
            <div class="ios-input-group">
                <label class="ios-label">Distância Retorno (Km)</label>
                <input type="number" id="retKm" value="500" class="ios-input">
            </div>
            
            <div style="display:flex; gap:15px; margin-bottom:20px">
                <div style="flex:1; background:var(--ios-input-bg); padding:10px; border-radius:8px; text-align:center">
                    <span class="ios-label">Custo Vazio</span>
                    <span id="costEmpty" style="color:var(--brand-red); font-weight:700; font-size:16px">R$ 0</span>
                </div>
                <div style="flex:1; background:var(--ios-input-bg); padding:10px; border-radius:8px; text-align:center">
                    <span class="ios-label">Break-Even</span>
                    <span id="costTarget" style="color:var(--brand-green); font-weight:700; font-size:16px">R$ 0</span>
                </div>
            </div>

            <button class="ios-btn" onclick="calcReturn()">Calcular</button>
        </div>
    </div>

    <script>
        const fmtMoney = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
        
        // --- DATA ---
        const routesData = [
            { id: 1, name: "Rota Norte (BR-163)", dest: "Sinop", distance: "500 km", costKm: 6.80, revenue: 154000, status: "high", coords: [ [-15.6014, -56.0979], [-11.8553, -55.5056] ] },
            { id: 2, name: "Rota Sul (BR-364)", dest: "Rondonópolis", distance: "215 km", costKm: 6.40, revenue: 98000, status: "med", coords: [ [-15.6014, -56.0979], [-16.4674, -54.6382] ] },
            { id: 3, name: "Rota Médio-Norte", dest: "Lucas R. Verde", distance: "350 km", costKm: 6.60, revenue: 120000, status: "high", coords: [ [-15.6014, -56.0979], [-13.0569, -55.9127] ] },
            { id: 4, name: "Rota Oeste", dest: "Tangará", distance: "240 km", costKm: 6.90, revenue: 45000, status: "low", coords: [ [-15.6014, -56.0979], [-14.6214, -57.4870] ] }
        ];

        let map;

        function toggleMenu() {
            const drawer = document.getElementById('mainDrawer');
            const overlay = document.getElementById('drawerOverlay');
            if(drawer.classList.contains('active')) {
                drawer.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                drawer.classList.add('active');
                overlay.classList.add('active');
            }
        }

        window.onload = () => {
            initMap();
            renderRoutes();
            initChart();
            calcReturn();
        };

        // --- MAP ---
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([-14.0, -56.0], 6);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '', maxZoom: 19
            }).addTo(map);

            // Hub Marker
            const iconHub = L.divIcon({
                className: 'custom-div-icon',
                html: "<div style='background-color:#ffd60a; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow:0 0 10px #ffd60a'></div>",
                iconSize: [12, 12]
            });
            L.marker([-15.6014, -56.0979], { icon: iconHub }).addTo(map);

            // Routes
            routesData.forEach(route => {
                let color = '#ff9f0a';
                if(route.status === 'high') color = '#30d158';
                if(route.status === 'low') color = '#ff453a';

                const polyline = L.polyline(route.coords, { color: color, weight: 3, opacity: 0.8 }).addTo(map);
                
                L.circleMarker(route.coords[1], {
                    color: color, fillColor: color, fillOpacity: 1, radius: 5
                }).addTo(map).bindPopup(`<b>${route.dest}</b><br>${route.distance}`);
            });
        }

        // --- LIST ---
        function renderRoutes() {
            const container = document.getElementById('routesContainer');
            container.innerHTML = '';

            routesData.forEach(route => {
                const html = `
                    <div class="route-card ${route.status}" onclick="flyToRoute(${route.id})">
                        <div class="rc-header">
                            <span class="rc-name">${route.dest}</span>
                            <span class="rc-dist">${route.distance}</span>
                        </div>
                        <div class="rc-stats">
                            <div>Fat: <strong>${fmtMoney.format(route.revenue)}</strong></div>
                            <div>Custo: <strong>R$ ${route.costKm.toFixed(2)}/km</strong></div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function flyToRoute(id) {
            const route = routesData.find(r => r.id === id);
            if(route) {
                map.flyTo(route.coords[1], 9);
            }
        }

        // --- TOOLS ---
        function openCalc() { document.getElementById('calcModal').style.display = 'flex'; }
        
        function closeCalc(e) {
            if(e.target.id === 'calcModal') document.getElementById('calcModal').style.display = 'none';
        }

        function calcReturn() {
            const km = parseFloat(document.getElementById('retKm').value) || 0;
            const dieselAvg = 6.52;
            const consumption = 2.2;
            
            const liters = km / consumption;
            const cost = liters * dieselAvg;
            const maint = km * 0.85;
            const totalCost = cost + maint;

            document.getElementById('costEmpty').innerText = fmtMoney.format(totalCost);
            document.getElementById('costTarget').innerText = fmtMoney.format(totalCost * 1.2);
        }

        // --- CHART ---
        function initChart() {
            const ctx = document.getElementById('zoneChart').getContext('2d');
            Chart.defaults.font.family = "-apple-system, sans-serif";
            Chart.defaults.color = "#8e8e93";
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Norte', 'Sul', 'Oeste', 'Médio'],
                    datasets: [{
                        label: 'Mg %',
                        data: [18, 12, 5, 15],
                        backgroundColor: ['#30d158', '#ff9f0a', '#ff453a', '#30d158'],
                        borderRadius: 4,
                        barThickness: 15
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false } },
                        y: { display: false }
                    }
                }
            });
        }

    </script>
</body>
</html>